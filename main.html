<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>Pop Puyo</title>
<script type="text/javascript" src="js/jquery-1.7.2.min.js"></script>
<script type="text/javascript">
var FPS = 30;
var FIELD_COL_MAX   = 6;
var FIELD_ROW_MAX   = 14;
var CELL_SIZE       = 24;
var FIELD_WIDTH     = 720;
var FIELD_HIGHT     = 480;
// Input Key Value
var INPUT_KEY_LEFT  = 37;
var INPUT_KEY_UP    = 38;
var INPUT_KEY_RIGHT = 39;
var INPUT_KEY_DOWN  = 40;
var INPUT_KEY_Z     = 90; // Z：左回転
var INPUT_KEY_X     = 88; // X: 右回転    
// Number of Puyo
var PUYO_TYPE_NUM   = 5; // ぷよぷよの種類    
// 
var BLOCK_TYPE_NONE     = 0;
var BLOCK_TYPE_BLUE     = 1; // blue
var BLOCK_TYPE_GREEN    = 2; // green
var BLOCK_TYPE_PURPLE   = 3; // purple
var BLOCK_TYPE_RED      = 4; // red
var BLOCK_TYPE_YELLOW   = 5; // yellow
var BLOCK_TYPE_OJAMA    = 6; // ojama
var BLOCK_TYPE_WALL     = 7; // wall
    
var inputKey; // 
    
// 各ぷよぷよの画像ファイル名
var names = {};
names[BLOCK_TYPE_BLUE]      = "pb"; 
names[BLOCK_TYPE_GREEN]     = "pg"; 
names[BLOCK_TYPE_PURPLE]    = "pp"; 
names[BLOCK_TYPE_RED]       = "pr"; 
names[BLOCK_TYPE_YELLOW]    = "py"; 
names[BLOCK_TYPE_OJAMA]     = "po"; 
names[BLOCK_TYPE_WALL]      = "pw";
    

// 各ぷよぷよ画像のリスト
var imgs = {};
for ( var key in names ){
    var img = new Image();
    img.src = "img/" + names[key] + ".gif";
    imgs[key] = img;
}

/**
 * ぷよを取り扱うクラス
 */
var Puyo = function(r, c){
    this.r = r;
    this.c = c;
    this.type = Math.floor(Math.random() * PUYO_TYPE_NUM) + 1;
    this.controllable = false; // 着地しているかどうか
    /**
     * ぷよを描画する
     * @param Context ctx
     */
    this.render = function(ctx){
        var w = imgs[this.type].width;
        var h = imgs[this.type].height;
        ctx.save();
        ctx.drawImage(imgs[this.type], 0, 0, w, h, this.c * CELL_SIZE, this.r * CELL_SIZE, CELL_SIZE, CELL_SIZE);
        ctx.restore();
    };
};

// Initialize field.
var field = [];
for ( var r = 0; r < FIELD_ROW_MAX; ++r ){
    var line = [];
    for ( var c = 0; c < FIELD_COL_MAX; ++c ){
        line.push(BLOCK_TYPE_NONE);
    }
    field.push(line);
}
var controllable = true;
    
$(document).ready(function() {
    var canvas = document.getElementById("field");
    var ctx = canvas.getContext("2d");
    var gameCount = 0;
    
    // 落下ぷよの生成
    var puyopuyo = [];
    puyopuyo.push( new Puyo(0, FIELD_COL_MAX / 2) );
    puyopuyo.push( new Puyo(1, FIELD_COL_MAX / 2) );
    
    var inField = function(tr, tc){
        return ( 0 <= tr && tr < FIELD_ROW_MAX && 0 <= tc && tc < FIELD_COL_MAX );
    };
    
    var collision = function(tr, tc){
        return ( ( inField(tr, tc) && field[tr][tc] != BLOCK_TYPE_NONE ) || 
                !inField(tr, tc) );
    };
    
    var canMove = function(){
                  
        for ( var i = 0; i < puyopuyo.length; ++i ){
            var nr = puyopuyo[i].r, nc = puyopuyo[i].c;
            // ぷよの自然落下
            if ( gameCount % 4 == 0 ) ++nr;
            
            // updating phase
            if ( inputKey == INPUT_KEY_DOWN ){
                ++nr;
            } else if ( inputKey == INPUT_KEY_LEFT ){
                --nc;
            } else if ( inputKey == INPUT_KEY_RIGHT ){
                ++nc;
            } 
            
            // update the poyopuyo position
            if ( collision(nr, nc) ) {
                return false;
            }
        }
        
        // 回転できるかどうか
        if ( gameCount % 2 == 0 && inputKey == INPUT_KEY_Z ){
            for ( var i = 1; i < puyopuyo.length; ++i ){
                var dr = puyopuyo[i].r - puyopuyo[0].r;
                var dc = puyopuyo[i].c - puyopuyo[0].c;
                var nr = puyopuyo[i].r - dr + dc;
                var nc = puyopuyo[i].c - dc - dr;
                if ( collision(nr, nc) ){
                    return false;
                }
            }
        } 
        
        return true;
    }
    
    var move = function(){
        if ( gameCount % 3 != 0 ) return;
        for ( var i = 0; i < puyopuyo.length; ++i ){
            var nr = puyopuyo[i].r, nc = puyopuyo[i].c;
            // ぷよの自然落下
            if ( gameCount % 4 == 0 ) ++nr;
            // updating phase
            if ( inputKey == INPUT_KEY_DOWN ){
                ++nr;
            } else if ( inputKey == INPUT_KEY_LEFT ){
                --nc;
            } else if ( inputKey == INPUT_KEY_RIGHT ){
                ++nc;
            } 
            
            puyopuyo[i].r = nr;
            puyopuyo[i].c = nc;
        }
        
        // 回転する
        if ( inputKey == INPUT_KEY_Z ){
            for ( var i = 1; i < puyopuyo.length; ++i ){
                var dr = puyopuyo[i].r - puyopuyo[0].r;
                var dc = puyopuyo[i].c - puyopuyo[0].c;
                var nr = puyopuyo[i].r - dr + dc;
                var nc = puyopuyo[i].c - dc - dr;
                puyopuyo[i].r = nr;
                puyopuyo[i].c = nc;
            }
        } 
    }
    
    var canDrop = function(){
        for ( var r = FIELD_ROW_MAX-2; r >= 0; --r ){
            for ( var c = 0; c < FIELD_COL_MAX; ++c ){
                if ( field[r][c] != BLOCK_TYPE_NONE &&
                     field[r+1][c] == BLOCK_TYPE_NONE ){
                    return true;
                }
            }
        }
        return false;
    };
    
    var drop = function(){
        for ( var r = FIELD_ROW_MAX-2; r >= 0; --r ){
            for ( var c = 0; c < FIELD_COL_MAX; ++c ){
                if ( field[r][c] != BLOCK_TYPE_NONE &&
                    field[r+1][c] == BLOCK_TYPE_NONE ){
                    field[r+1][c] = field[r][c];
                    field[r][c] = BLOCK_TYPE_NONE;
                }
            }
        }
    }
    
    var len = function(v){
        var cnt = 0;
        for ( k in v ) ++cnt;
        return cnt;
    }
      
    /**
     * ぷよが削除されたかどうか。削除されたら、true, そうでなければ false を返す
     * BFS algorithm
     * @return bool 
     */
    var erased = function(){
        var used = [];
        for ( var r = 0; r < FIELD_ROW_MAX; ++r ){
            var line = [];
            for ( var c = 0; c < FIELD_COL_MAX; ++c ){
                line.push(false);
            }
            used.push(line);
        }
        var can = false; // ぷよを消去できるかどうか
        
        var dr = [1, 0, -1, 0];
        var dc = [0, 1, 0, -1];
        for ( var r = FIELD_ROW_MAX-1; r >= 0; --r ){
            for ( var c = 0; c < FIELD_COL_MAX; ++c ){
                if ( !used[r][c] && field[r][c] != BLOCK_TYPE_NONE ){
                    var type = field[r][c].type;
                    var queue = [{r:r,c:c}];
                    used[r][c] = true;
                    var list = [{r:r,c:c}]; // 連結しているぷよの位置
                    while ( queue.length > 0 ){
                        var pos = queue.pop();
                        var cr = pos.r;
                        var cc = pos.c;
                        for ( var i = 0; i < 4; ++i ){
                            var nr = cr + dr[i];
                            var nc = cc + dc[i];
                            if ( inField(nr,nc) && 
                                !used[nr][nc] &&
                                field[cr][cc] == field[nr][nc]){
                                queue.push({r:nr,c:nc});
                                used[nr][nc] = true;
                                list.push({r:nr,c:nc});
                            }
                        }
                    }
                    if ( list.length >= 4 ){ // 連鎖
                        can = true;
                        for ( var i = 0; i < list.length; ++i ){
                            field[list[i].r][list[i].c] = BLOCK_TYPE_NONE;
                        }
                    }
                }
            }
        }
        
        return can;
    };
                  
    var main = function() {
        if ( controllable ){
            if ( canMove() ){
                move();
            }
            // 着地する
            for ( var i = 0; i < puyopuyo.length; ++i ){
                var r = puyopuyo[i].r;
                var c = puyopuyo[i].c;
                if ( (inField(r+1,c) && field[r+1][c] != BLOCK_TYPE_NONE) || r+1 == FIELD_ROW_MAX ){
                    controllable = false;
                }
            }
            if ( !controllable ){
                for ( var i = 0; i < puyopuyo.length; ++i ){
                    var r = puyopuyo[i].r;
                    var c = puyopuyo[i].c;
                    field[r][c] = puyopuyo[i].type;
                }
            }
        } else {
            if ( canDrop() ){ // 落下しているぷよが存在
                drop();
            } else { // 落下しているぷよが存在しない
                if ( erased() ){ // ぷよぷよが消されたかどうか
                    
                } else {
                    // 新しいぷよぷよを生成
                    for ( i = 0; i < puyopuyo.length; ++i ){
                        puyopuyo[i] = new Puyo(i, FIELD_COL_MAX / 2);
                    }
                    controllable = true;
                }
            }
        }
        
        // rendering phase
        ctx.clearRect(0, 0, FIELD_WIDTH, FIELD_HIGHT);
        for ( var i = 0; i < puyopuyo.length; ++i ){
            puyopuyo[i].render(ctx);
        }
               
        for ( var r = 0; r < FIELD_ROW_MAX; ++r ){
            for ( var c = 0; c < FIELD_COL_MAX; ++c ){
                if ( field[r][c] != BLOCK_TYPE_NONE ){  
                    var type = field[r][c];
                    var w = imgs[type].width;
                    var h = imgs[type].height;
                    ctx.save();
                    ctx.drawImage(imgs[type], 0, 0, w, h, c * CELL_SIZE, r * CELL_SIZE, CELL_SIZE, CELL_SIZE);
                    ctx.restore();
                }
            }
        }
        
        ++gameCount;
    };
      
    window.document.onkeydown = function(event){
        inputKey = event.keyCode;
    };
    window.document.onkeyup = function(event){
        inputKey = 0;
    };
    
    // set FPS
    setInterval(main, 1000 / FPS);
    
});
</script>
</head>
<body>
	<canvas id="field" width="144" height="336" style="background: black"></canvas>
</body>
</html>
